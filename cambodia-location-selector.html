<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cambodia Location Selector</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8">

  <div class="card w-96 bg-base-100 shadow-md p-6">
    <h2 class="text-lg font-bold text-primary mb-4">Location Selector</h2>

    <!-- Province -->
    <div class="form-control mb-3">
      <label class="label"><span class="label-text font-semibold">Province</span></label>
      <select id="province" class="select select-bordered w-full">
        <option value="">Select Province</option>
      </select>
    </div>

    <!-- District -->
    <div class="form-control mb-3">
      <label class="label"><span class="label-text font-semibold">District</span></label>
      <select id="district" class="select select-bordered w-full" disabled>
        <option value="">Select District</option>
      </select>
    </div>

    <!-- Commune -->
    <div class="form-control mb-3">
      <label class="label"><span class="label-text font-semibold">Commune</span></label>
      <select id="commune" class="select select-bordered w-full" disabled>
        <option value="">Select Commune</option>
      </select>
    </div>

    <!-- Village -->
    <div class="form-control mb-4">
      <label class="label"><span class="label-text font-semibold">Village</span></label>
      <select id="village" class="select select-bordered w-full" disabled>
        <option value="">Select Village</option>
      </select>
    </div>

    <!-- Buttons -->
    <div class="flex gap-2 justify-end">
      <button class="btn btn-primary" onclick="submitForm()">Submit</button>
      <button class="btn btn-ghost" onclick="resetForm()">Reset</button>
    </div>
  </div>

<script>

const API_BASE = "https://cambo-gazetteer.manethpak.dev/api/v1";
const PROXY = "https://corsproxy.io/?";

const provinceEl = document.getElementById("province");
const districtEl = document.getElementById("district");
const communeEl  = document.getElementById("commune");
const villageEl  = document.getElementById("village");


// ✅ FIX: define fetchAPI function
async function fetchAPI(url)
{
  const res = await fetch(PROXY + encodeURIComponent(url));
  return await res.json();
}


// Helper: fill select
function fillSelect(selectEl, items, placeholder)
{
  selectEl.innerHTML = `<option value="">${placeholder}</option>`;

  items.forEach(item =>
  {
    const option = document.createElement("option");

    option.value = item.id;
    option.textContent = `${item.name_en} (${item.name_km})`;

    selectEl.appendChild(option);
  });
}


// Helper: reset select
function resetSelect(selectEl, placeholder)
{
  selectEl.innerHTML = `<option value="">${placeholder}</option>`;
  selectEl.disabled = true;
}


// Load provinces
async function loadProvinces()
{
  const data = await fetchAPI(`${API_BASE}/provinces`);

  console.log("PROVINCES:", data);

  fillSelect(provinceEl, data.data, "Select Province");
}


// PROVINCE → DISTRICT
provinceEl.onchange = async function()
{
  resetSelect(districtEl, "Select District");
  resetSelect(communeEl, "Select Commune");
  resetSelect(villageEl, "Select Village");

  if(!this.value) return;

  const data =
  await fetchAPI(`${API_BASE}/districts?province_id=${this.value}`);

  console.log("DISTRICTS:", data);

  fillSelect(districtEl, data.data, "Select District");

  districtEl.disabled = false;
};


// DISTRICT → COMMUNE
districtEl.onchange = async function()
{
  resetSelect(communeEl, "Select Commune");
  resetSelect(villageEl, "Select Village");

  if(!this.value) return;

  const data =
  await fetchAPI(`${API_BASE}/communes?district_id=${this.value}`);

  console.log("COMMUNES:", data);

  fillSelect(communeEl, data.data, "Select Commune");

  communeEl.disabled = false;
};


// COMMUNE → VILLAGE
communeEl.onchange = async function()
{
  resetSelect(villageEl, "Select Village");

  if(!this.value) return;

  const data =
  await fetchAPI(`${API_BASE}/villages?commune_id=${this.value}`);

  console.log("VILLAGES:", data);

  fillSelect(villageEl, data.data, "Select Village");

  villageEl.disabled = false;
};


// Submit
function submitForm()
{
  if (!provinceEl.value) return alert("Please select Province");
  if (!districtEl.value) return alert("Please select District");
  if (!communeEl.value) return alert("Please select Commune");
  if (!villageEl.value) return alert("Please select Village");

  alert(`
Province: ${provinceEl.selectedOptions[0].text}
District: ${districtEl.selectedOptions[0].text}
Commune: ${communeEl.selectedOptions[0].text}
Village: ${villageEl.selectedOptions[0].text}
  `);
}


// Reset
function resetForm()
{
  provinceEl.value = "";

  resetSelect(districtEl, "Select District");
  resetSelect(communeEl, "Select Commune");
  resetSelect(villageEl, "Select Village");
}


// Init
loadProvinces();

</script>

</body>
</html>